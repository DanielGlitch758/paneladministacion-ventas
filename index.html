<script type="module">

/* ================= FIREBASE ================= */

import { initializeApp } from
"https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";

import {
  getFirestore,
  doc,
  getDoc,
  setDoc
} from
"https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

import {
  getAuth,
  onAuthStateChanged
} from
"https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";


/* ================= CONFIG ================= */

const firebaseConfig = {
  apiKey: "AIzaSyCQz9xniOmKrjgNjVRpBn-admbqvRDQ2YA",
  authDomain: "panel-administracion-ventas.firebaseapp.com",
  projectId: "panel-administracion-ventas",
  storageBucket: "panel-administracion-ventas.firebasestorage.app",
  messagingSenderId: "379063339131",
  appId: "1:379063339131:web:fa4583237cec4e8ca2fade"
};


/* ================= INIT ================= */

const app  = initializeApp(firebaseConfig);
const db   = getFirestore(app);
const auth = getAuth(app);

window.db = db;


/* ================= DATOS ================= */

let clientes = [];
let caidas   = [];


/* ================= AUTH ================= */

onAuthStateChanged(auth, user => {

  if (!user) {
    window.location.href = "login.html";
    return;
  }

});


/* ================= FIRESTORE ================= */

async function cargarDesdeNube(){

  try{

    const snap = await getDoc(doc(db,"panel","datos"));

    if(snap.exists()){

      clientes = snap.data().clientes || [];
      caidas   = snap.data().caidas   || [];

    }

  }catch(e){
    console.error("Error carga:",e);
  }

}


async function guardarEnNube(){

  try{

    await setDoc(doc(db,"panel","datos"),{
      clientes,
      caidas,
      actualizado: new Date()
    });

  }catch(e){
    console.error("Error guardado:",e);
  }

}


/* ================= INIT APP ================= */

document.addEventListener("DOMContentLoaded", async ()=>{

  await cargarDesdeNube();

  if(typeof actualizarEstadisticas==="function") actualizarEstadisticas();
  if(typeof renderizarClientes==="function") renderizarClientes();
  if(typeof verificarAlertas==="function") verificarAlertas();
  if(typeof actualizarEstadisticasCaidas==="function") actualizarEstadisticasCaidas();
  if(typeof renderizarCaidas==="function") renderizarCaidas();

});


/* ================= HOOK LOCAL → CLOUD ================= */

/* Reemplaza tu guardado local */

if(window.guardarEnLocalStorage){

  const oldSave = window.guardarEnLocalStorage;

  window.guardarEnLocalStorage = async function(){

    await guardarEnNube();

  };

}


/* ================= CLIENTES ================= */

window.guardarCliente = async function (event) {

  event.preventDefault();

  const producto = document.getElementById('producto').value;

  const cliente = {

    id: Date.now(),

    nombre: document.getElementById('nombre').value,
    email: document.getElementById('email').value,
    telefono: document.getElementById('telefono').value,
    producto: producto,

    metodoPago: document.getElementById('metodoPago').value,
    tipoCliente: document.getElementById('tipoCliente').value,
    fuenteAdquisicion: document.getElementById('fuenteAdquisicion').value,

    notas: document.getElementById('notas').value,

    estado: 'activo',
    fechaCreacion: new Date().toISOString()

  };


  /* SUSCRIPCIONES */

  if (producto === 'streaming' || producto === 'canva') {

    cliente.fechaInicio     = document.getElementById('fechaInicio').value;
    cliente.duracion        = parseInt(document.getElementById('duracion').value);
    cliente.fechaRenovacion = document.getElementById('fechaRenovacion').value;

    cliente.precioVenta    = parseFloat(document.getElementById('precioVenta').value);
    cliente.costoProveedor = parseFloat(document.getElementById('costoProveedor').value) || 0;

    cliente.tipoProducto = 'suscripcion';

    cliente.historial = [{
      fecha: new Date().toISOString(),
      accion: 'Registro',
      monto: cliente.precioVenta
    }];

  }


  /* CINEPOLIS */

  if (producto === 'cinepolis') {

    cliente.fechaVenta = document.getElementById('fechaVentaCine').value;

    cliente.cantidadBoletos   = parseInt(document.getElementById('cantidadBoletos').value);
    cliente.alimentosVendidos = document.getElementById('alimentosVendidos').value;

    cliente.costoProveedorCine = parseFloat(document.getElementById('costoProveedorCine').value) || 0;
    cliente.costoCliente       = parseFloat(document.getElementById('costoCliente').value) || 0;

    cliente.comisionPropia = parseFloat(document.getElementById('comisionPropia').value);

    cliente.precioVenta    = cliente.comisionPropia;
    cliente.costoProveedor = 0;

    cliente.tipoProducto = 'venta_unica';
    cliente.estado = 'completado';

    cliente.historial = [{
      fecha: new Date().toISOString(),
      accion: 'Venta',
      monto: cliente.comisionPropia
    }];

  }


  clientes.push(cliente);

  await guardarEnNube();

  limpiarFormulario();
  switchTab('clientes');

  actualizarEstadisticas();
  renderizarClientes();

};


/* ================= ELIMINAR ================= */

window.eliminarCliente = async function (id, silencioso=false) {

  if (!silencioso && !confirm("¿Eliminar cliente?")) return;

  clientes = clientes.filter(c => c.id !== id);

  await guardarEnNube();

  actualizarEstadisticas();
  renderizarClientes();

};


/* ================= UTILS ================= */

function calcularGanancia(c){

  if(c.tipoProducto === 'venta_unica'){
    return c.comisionPropia || 0;
  }

  return (c.precioVenta||0)-(c.costoProveedor||0);

}


window.formatearFecha = function (f){

  if(!f) return '-';

  return new Date(f).toLocaleDateString('es-MX',{
    year:'numeric',
    month:'short',
    day:'numeric'
  });

}


console.log("Panel Firebase listo");

</script>
